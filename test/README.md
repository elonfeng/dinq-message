# dinq_message 集成测试

## 测试文件结构

测试按功能维度拆分为7个文件，共约2738行代码：

### 1. `helpers_test.go` (192行)
公共辅助函数和测试配置
- JWT生成和用户创建
- HTTP请求辅助函数
- WebSocket连接和消息收发
- 数据查询和解析辅助函数

### 2. `basic_chat_test.go` (589行)
基础聊天功能测试
- **私聊基础** (5个测试)
  - 自动创建会话
  - 会话不重复创建
  - 并发创建幂等性
  - 不同消息类型（text/image/emoji）
  - 消息回复功能

- **群聊基础** (2个测试)
  - 创建群聊并发送消息
  - 群成员离开

- **未读计数** (2个测试)
  - 未读增加和清零
  - 群聊多人发送的未读累加

### 3. `websocket_auth_test.go` (246行)
WebSocket连接和鉴权测试
- **WebSocket连接** (3个测试)
  - 连接和断开
  - 心跳机制(ping/pong)
  - 在线状态更新

- **鉴权** (4个测试)
  - 无token连接拒绝
  - 无效token拒绝
  - 过期token拒绝
  - HTTP接口鉴权
  - 有效token验证

### 4. `configurable_features_test.go` (525行)
可配置功能测试
- **首条消息限制** (4个测试)
  - 启用限制验证
  - 对方回复后恢复
  - 关闭限制
  - 群聊不受限

- **已读回执** (1个测试)
  - 启用时收到回执通知

- **正在输入提示** (1个测试)
  - 启用时收到typing事件

- **拉黑功能** (4个测试)
  - 拉黑后发消息拒绝
  - 取消拉黑恢复
  - 已有会话仍可见
  - 获取拉黑列表

### 5. `advanced_features_test.go` (411行)
高级功能测试
- **消息撤回** (3个测试)
  - 2分钟内撤回成功
  - 撤回他人消息拒绝
  - 重复撤回拒绝

- **群聊权限** (2个测试)
  - 只有owner能添加成员
  - 只有owner能踢人

- **通知推送** (2个测试)
  - 新消息通知
  - 标记通知已读

- **离线消息** (1个测试)
  - 上线后收到离线消息

### 6. `performance_test.go` (299行)
性能和并发测试
- **N+1查询验证** (1个测试)
  - 查询10个会话验证无N+1问题
  - 响应时间<2秒

- **并发场景** (1个测试)
  - 100并发发送消息
  - 成功率>=80%
  - 总耗时<30秒

- **事务一致性** (1个测试)
  - 消息表和会话表数据一致
  - last_message_id正确更新

- **索引效率** (1个测试)
  - 50个会话×10条消息
  - 会话列表查询<1秒
  - 消息历史查询<500ms

### 7. `edge_cases_test.go` (476行)
边界和错误处理测试
- **输入验证** (4个测试)
  - 空内容消息
  - 无效消息类型
  - 超大消息(10KB)
  - 快速连续发送

- **不存在的资源** (3个测试)
  - 访问不存在的会话
  - 给不存在的用户发消息
  - 访问他人会话

- **特殊场景** (3个测试)
  - 给自己发消息
  - 发送无效JSON
  - 缺少必填字段

- **会话管理** (2个测试)
  - 空会话列表
  - 分页边界测试

## 测试特点

### 1. 详细注释
每个测试方法上都有详细注释说明：
- **测试目标**：说明要验证什么功能
- **验证闭环**：列出完整的验证步骤，确保数据库状态正确

示例：
```go
// TestPrivateChat_AutoCreateConversation 测试私聊自动创建会话
//
// 测试目标：
// - 用户A给用户B首次发送消息时，系统自动创建私聊会话
//
// 验证闭环：
// 1. A发送消息成功，收到带conversation_id的响应
// 2. A查询会话列表，能看到新创建的会话
// 3. 会话类型为"private"
// 4. 会话包含2个成员（A和B）
```

### 2. 完整闭环验证
每个测试不仅验证API响应，还验证数据库状态：
- 发送消息后，查询消息历史验证消息存在
- 创建会话后，查询会话列表验证会话状态
- 标记已读后，查询未读计数验证归零
- 撤回消息后，查询消息验证is_recalled=true

### 3. 按维度组织
- 基础功能测试：验证核心业务逻辑
- 可配置功能测试：验证可开关的功能
- 高级功能测试：验证复杂功能
- 性能测试：验证性能指标和并发处理
- 边界测试：验证边界情况和错误处理

## 运行测试

### 前提条件
1. 启动PostgreSQL数据库
2. 启动Redis
3. 运行init.sql初始化数据库
4. 启动dinq_message服务（监听8081端口）

### 配置
修改`helpers_test.go`中的配置：
```go
var (
    BaseURL   = "http://localhost:8081"
    WSURL     = "ws://localhost:8081"
    JWTSecret = "your-secret-key" // 和服务端保持一致
)
```

### 运行全部测试
```bash
cd test
go test -v
```

### 运行指定文件测试
```bash
# 只测试基础功能
go test -v -run TestPrivateChat

# 只测试性能
go test -v -run TestPerformance

# 只测试边界情况
go test -v -run TestEdgeCase
```

### 运行单个测试
```bash
go test -v -run TestPrivateChat_AutoCreateConversation
```

## 测试覆盖

### 功能覆盖
- ✅ 私聊（创建、发送、查询）
- ✅ 群聊（创建、发送、成员管理、权限）
- ✅ 消息类型（text、image、emoji）
- ✅ 消息回复
- ✅ 未读计数
- ✅ 消息撤回
- ✅ WebSocket连接管理
- ✅ JWT鉴权
- ✅ 首条消息限制（可配置）
- ✅ 已读回执（可配置）
- ✅ 正在输入提示（可配置）
- ✅ 拉黑功能
- ✅ 通知推送
- ✅ 离线消息

### 性能覆盖
- ✅ N+1查询修复验证
- ✅ 并发消息发送（100并发）
- ✅ 事务一致性
- ✅ 索引效率验证

### 边界覆盖
- ✅ 空/无效输入
- ✅ 不存在的资源
- ✅ 权限控制
- ✅ 特殊场景（自己给自己发消息等）
- ✅ 分页边界

## 注意事项

1. **测试隔离**：每个测试创建独立的测试用户，避免相互影响
2. **异步等待**：WebSocket消息接收使用超时机制（通常3秒）
3. **可选功能**：某些测试（如在线状态、已读回执）如果功能未实现也会通过
4. **性能测试**：性能测试可能受机器性能影响，阈值可以调整
5. **数据清理**：建议使用测试专用数据库，或在测试后清理数据

## 统计

- 总测试数：约**50+个**测试用例
- 总代码行数：**2738行**
- 测试文件数：**7个**
- 覆盖功能点：**15+个**主要功能
